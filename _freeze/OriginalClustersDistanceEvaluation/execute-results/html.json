{
  "hash": "f51c9a79bb1b668ff227f5eae7b91ba7",
  "result": {
    "markdown": "---\ntitle: \"Original Clusters Distance Evaluation\"\nauthor: \"seriph78\"\ndate: \"2023-11-23\"\noutput: html_document\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(COTAN)\nlibrary(stringr)\nlibrary(tidyverse)\n```\n:::\n\n\n## Extract the row matrix for each cluster\n\nThis is done on the La Manno Mouse Brain dataset (2021)\n\n### E13.5\n\n\n::: {.cell}\n\n```{.r .cell-code}\nE13.5Clusters.code <- c(432,187,434,184,437,510)\n\nfb135Obj <- readRDS(file = file.path(\"Data/MouseCortexFromLoom/\", \"e13.5_ForebrainDorsal.cotan.RDS\"))\n\nsampleCondition <- getMetadataElement(fb135Obj, datasetTags()[[\"cond\"]])\n\nfor (cl in E13.5Clusters.code) {\n  cells <- names(getClusters(fb135Obj, \n      clName = \"original.clusters\")[getClusters(fb135Obj, \n                          clName = \"original.clusters\") == cl])\n\nCLRawData <- getRawData(fb135Obj)[,cells]\n\nsaveRDS(CLRawData,file = paste0(\"Data/MouseCortexFromLoom/SingleClusterRawData/Cl\",cl,sampleCondition,\"RawData.RDS\"))  \n}\n```\n:::\n\n\n### E15.0\n\n\n::: {.cell}\n\n```{.r .cell-code}\nE15.0Clusters.code <- c(432,509,510,508,428,434,437)\n\nfb150Obj <- readRDS(file = file.path(\"Data/MouseCortexFromLoom/\", \"e15.0_ForebrainDorsal.cotan.RDS\"))\n\nsampleCondition <- getMetadataElement(fb150Obj, datasetTags()[[\"cond\"]])\n\nfor (cl in E15.0Clusters.code) {\n  cells <- names(getClusters(fb150Obj, \n      clName = \"original.clusters\")[getClusters(fb150Obj, \n                          clName = \"original.clusters\") == cl])\n\nCLRawData <- getRawData(fb150Obj)[,cells]\n\nsaveRDS(CLRawData,file = paste0(\"Data/MouseCortexFromLoom/SingleClusterRawData/Cl\",cl,sampleCondition,\"RawData.RDS\"))  \n}\n```\n:::\n\n\n### E17.5\n\n\n::: {.cell}\n\n```{.r .cell-code}\nE17.5Clusters.code <- c(516,505)\n\nfb175Obj <- readRDS(file = file.path(\"Data/MouseCortexFromLoom/\", \"E17.5_ForebrainDorsal.cotan.RDS\"))\n\nsampleCondition <- getMetadataElement(fb175Obj, datasetTags()[[\"cond\"]])\n\nfor (cl in E17.5Clusters.code) {\n  cells <- names(getClusters(fb175Obj, \n      clName = \"original.clusters\")[getClusters(fb175Obj, \n                          clName = \"original.clusters\") == cl])\n\nCLRawData <- getRawData(fb175Obj)[,cells]\n\nsaveRDS(CLRawData,file = paste0(\"Data/MouseCortexFromLoom/SingleClusterRawData/Cl\",cl,sampleCondition,\"RawData.RDS\"))  \n}\n```\n:::\n\n\n## Defining the two distances\n\nTo roughly determine the cluster distances we decided to test two simple Euclidean distances:\n\n1.  over the mean of the 0/1 raw matrix\n\n2.  over the $1-e^{-\\lambda}$ where $\\lambda$ is the average expression for the genes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nClFiles <- list.files(\"Data/MouseCortexFromLoom/SingleClusterRawData/\")\n\ntot.Df.ZeroOne <- NA\ntot.Df.Lambda <- NA\nfor(Fl in ClFiles) {\n  print(Fl)\n  cl <- str_split(Fl,pattern = \"_\",simplify = T)[1]\n  data <- readRDS(paste0(\"Data/MouseCortexFromLoom/SingleClusterRawData/\",\n                         Fl))\n  \n  obj <- COTAN(data)\n  \n  ZeroOne <- rowMeans(as.matrix(getZeroOneProj(obj)))\n  tot.Df.ZeroOne <- merge(tot.Df.ZeroOne,ZeroOne,by = 0,all = T)\n  tot.Df.ZeroOne[is.na(tot.Df.ZeroOne)] <- 0\n  colnames(tot.Df.ZeroOne)[ncol(tot.Df.ZeroOne)] <- cl\n  tot.Df.ZeroOne <- column_to_rownames(tot.Df.ZeroOne,var = \"Row.names\")\n  \n  obj <- estimateLambdaLinear(obj)\n  Lambda <- getLambda(obj)\n  tot.Df.Lambda <- merge(tot.Df.Lambda,1-exp(-Lambda),by = 0, all = T)\n  tot.Df.Lambda[is.na(tot.Df.Lambda)] <- 0\n  colnames(tot.Df.Lambda)[ncol(tot.Df.Lambda)] <- cl\n  tot.Df.Lambda <- column_to_rownames(tot.Df.Lambda,var = \"Row.names\")\n  \n}\ntot.Df.Lambda <- tot.Df.Lambda[,2:ncol(tot.Df.Lambda)]\ntot.Df.ZeroOne <- tot.Df.ZeroOne[,2:ncol(tot.Df.ZeroOne)]\n\ntot.Df.Lambda <- tot.Df.Lambda[2:nrow(tot.Df.Lambda),]\ntot.Df.ZeroOne <- tot.Df.ZeroOne[2:nrow(tot.Df.Lambda),]\n\n\nhead(tot.Df.Lambda)\nhead(tot.Df.ZeroOne)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(tot.Df.Lambda, \"Data/MouseCortexFromLoom/ClustersDistances/Tot.Df.Lambda.RDS\")\nsaveRDS(tot.Df.ZeroOne, \"Data/MouseCortexFromLoom/ClustersDistances/Tot.Df.ZeroOne.RDS\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ComplexHeatmap)\ndistance.df.Lambda <- as.matrix(dist(t(tot.Df.Lambda),diag = T,upper = T))\n\nHeatmap(distance.df.Lambda,\n        name = \"Lambda\\ndistance\", \n        cell_fun = function(j, i, x, y, width, height, fill) \n        {\n          grid.text(sprintf(\"%.1f\", distance.df.Lambda[i, j]), x, y, gp = gpar(fontsize = 10))\n        },\n        show_row_dend = F, \n        show_row_names = F)\n```\n\n::: {.cell-output-display}\n![](OriginalClustersDistanceEvaluation_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndistance.df.ZeroOne <- as.matrix(dist(t(tot.Df.ZeroOne),diag = T,upper = T))\n\nHeatmap(distance.df.ZeroOne,\n        name = \"ZeroOne\\ndistance\", \n        cell_fun = function(j, i, x, y, width, height, fill) \n        {\n          grid.text(sprintf(\"%.1f\", distance.df.ZeroOne[i, j]), x, y, gp = gpar(fontsize = 10))\n        },\n        show_row_dend = F, \n        show_row_names = F)\n```\n\n::: {.cell-output-display}\n![](OriginalClustersDistanceEvaluation_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nThe distances are very similar with the Zero One a little lower as values...\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistance.df.Lambda.Plot <- rownames_to_column(as.data.frame(distance.df.Lambda),\n                                              var = \"Cl.1\")\ndistance.df.Lambda.Plot <-pivot_longer(distance.df.Lambda.Plot,\n                                       cols = !Cl.1,\n                                       names_to = \"Cl.2\", \n                                       values_to = \"Lambda.Dist\")\n\ndistance.df.ZeroOne.Plot <- rownames_to_column(as.data.frame(distance.df.ZeroOne),\n                                              var = \"Cl.1\")\ndistance.df.ZeroOne.Plot <-pivot_longer(distance.df.ZeroOne.Plot,\n                                       cols = !Cl.1,\n                                       names_to = \"Cl.2\", \n                                       values_to = \"ZeroOne.Dist\")\n\ndistance.df.Tot <- merge(distance.df.ZeroOne.Plot,distance.df.Lambda.Plot,by= c(\"Cl.1\",\"Cl.2\"),all=T)\n\nggplot(as.data.frame(distance.df.Tot),aes(x=ZeroOne.Dist, y=Lambda.Dist))+geom_point()\n```\n\n::: {.cell-output-display}\n![](OriginalClustersDistanceEvaluation_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nSo for what we are using it is the same.\n\nThe key information is that we can define couple of, in one case, triplets of very near clusters:\n\n1.  Cl510e13.5 and Cl510e15.0\n2.  Cl516e17.5 and Cl505e17.5\n3.  Cl509e15.0 and Cl508e15.0 which are also similar to Cl432e13.5 and Cl432e15.0\n4.  Cl432e13.5 and Cl432e15.0\n5.  Cl437e13.5 and Cl437e15.0\n6.  Cl428e15.0, Cl434e15.0 and Cl434e13.5\n\nBased on these distances we can consider three thresholds (with number of cluster pair):\n\n1.  less than 7 (first quartile)\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    sum(distance.df.ZeroOne < 7.1 & distance.df.ZeroOne > 0)/2\n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    ```\n    [1] 19\n    ```\n    :::\n    :::\n\n\n2.  between 9 and 11 (around median)\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    sum(distance.df.ZeroOne > 9 & distance.df.ZeroOne < 11)/2\n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    ```\n    [1] 20\n    ```\n    :::\n    :::\n\n\n3.  more than 13 (3rd quartile)\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    sum(distance.df.ZeroOne > 13)/2\n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    ```\n    [1] 32\n    ```\n    :::\n    :::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 20.04.6 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0\n\nlocale:\n [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       \n [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   \n [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          \n[10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   \n\ntime zone: Europe/Rome\ntzcode source: system (glibc)\n\nattached base packages:\n[1] grid      stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] ComplexHeatmap_2.16.0 lubridate_1.9.2       forcats_1.0.0        \n [4] dplyr_1.1.2           purrr_1.0.1           readr_2.1.4          \n [7] tidyr_1.3.0           tibble_3.2.1          ggplot2_3.4.2        \n[10] tidyverse_2.0.0       stringr_1.5.0         COTAN_2.3.0          \n\nloaded via a namespace (and not attached):\n  [1] RcppAnnoy_0.0.21          splines_4.3.2            \n  [3] later_1.3.1               polyclip_1.10-4          \n  [5] fastDummies_1.7.3         lifecycle_1.0.3          \n  [7] doParallel_1.0.17         globals_0.16.2           \n  [9] lattice_0.22-5            MASS_7.3-60              \n [11] dendextend_1.17.1         magrittr_2.0.3           \n [13] plotly_4.10.2             rmarkdown_2.24           \n [15] yaml_2.3.7                httpuv_1.6.11            \n [17] Seurat_5.0.0              sctransform_0.4.1        \n [19] spam_2.10-0               askpass_1.2.0            \n [21] sp_2.1-1                  spatstat.sparse_3.0-2    \n [23] reticulate_1.34.0         cowplot_1.1.1            \n [25] pbapply_1.7-2             RColorBrewer_1.1-3       \n [27] abind_1.4-5               Rtsne_0.16               \n [29] BiocGenerics_0.46.0       circlize_0.4.15          \n [31] IRanges_2.34.1            S4Vectors_0.38.1         \n [33] ggrepel_0.9.3             irlba_2.3.5.1            \n [35] listenv_0.9.0             spatstat.utils_3.0-3     \n [37] umap_0.2.10.0             goftest_1.2-3            \n [39] RSpectra_0.16-1           spatstat.random_3.2-1    \n [41] dqrng_0.3.0               fitdistrplus_1.1-11      \n [43] parallelly_1.36.0         DelayedMatrixStats_1.22.5\n [45] leiden_0.4.3              codetools_0.2-19         \n [47] DelayedArray_0.26.7       tidyselect_1.2.0         \n [49] shape_1.4.6               farver_2.1.1             \n [51] ScaledMatrix_1.8.1        viridis_0.6.4            \n [53] matrixStats_1.1.0         stats4_4.3.2             \n [55] spatstat.explore_3.2-1    jsonlite_1.8.7           \n [57] GetoptLong_1.0.5          ellipsis_0.3.2           \n [59] progressr_0.14.0          ggridges_0.5.4           \n [61] survival_3.5-7            iterators_1.0.14         \n [63] foreach_1.5.2             tools_4.3.2              \n [65] ica_1.0-3                 Rcpp_1.0.11              \n [67] glue_1.6.2                gridExtra_2.3            \n [69] xfun_0.39                 MatrixGenerics_1.12.3    \n [71] ggthemes_4.2.4            withr_2.5.0              \n [73] fastmap_1.1.1             fansi_1.0.4              \n [75] openssl_2.1.0             digest_0.6.33            \n [77] rsvd_1.0.5                timechange_0.2.0         \n [79] parallelDist_0.2.6        R6_2.5.1                 \n [81] mime_0.12                 colorspace_2.1-0         \n [83] Cairo_1.6-1               scattermore_1.2          \n [85] tensor_1.5                spatstat.data_3.0-1      \n [87] utf8_1.2.3                generics_0.1.3           \n [89] data.table_1.14.8         httr_1.4.6               \n [91] htmlwidgets_1.6.2         S4Arrays_1.2.0           \n [93] uwot_0.1.16               pkgconfig_2.0.3          \n [95] gtable_0.3.3              lmtest_0.9-40            \n [97] htmltools_0.5.5           dotCall64_1.1-0          \n [99] clue_0.3-64               SeuratObject_5.0.0       \n[101] scales_1.2.1              png_0.1-8                \n[103] knitr_1.43                rstudioapi_0.15.0        \n[105] tzdb_0.4.0                reshape2_1.4.4           \n[107] rjson_0.2.21              nlme_3.1-163             \n[109] zoo_1.8-12                GlobalOptions_0.1.2      \n[111] KernSmooth_2.23-22        parallel_4.3.2           \n[113] miniUI_0.1.1.1            RcppZiggurat_0.1.6       \n[115] pillar_1.9.0              vctrs_0.6.3              \n[117] RANN_2.6.1                promises_1.2.0.1         \n[119] BiocSingular_1.16.0       beachmat_2.16.0          \n[121] xtable_1.8-4              cluster_2.1.4            \n[123] evaluate_0.21             zeallot_0.1.0            \n[125] cli_3.6.1                 compiler_4.3.2           \n[127] rlang_1.1.1               crayon_1.5.2             \n[129] future.apply_1.11.0       labeling_0.4.2           \n[131] plyr_1.8.8                stringi_1.8.1            \n[133] viridisLite_0.4.2         deldir_1.0-9             \n[135] BiocParallel_1.34.2       assertthat_0.2.1         \n[137] munsell_0.5.0             lazyeval_0.2.2           \n[139] spatstat.geom_3.2-4       PCAtools_2.14.0          \n[141] Matrix_1.6-2              RcppHNSW_0.5.0           \n[143] hms_1.1.3                 patchwork_1.1.2          \n[145] sparseMatrixStats_1.12.2  future_1.33.0            \n[147] shiny_1.7.5               ROCR_1.0-11              \n[149] Rfast_2.1.0               igraph_1.5.1             \n[151] RcppParallel_5.1.7       \n```\n:::\n:::\n",
    "supporting": [
      "OriginalClustersDistanceEvaluation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}