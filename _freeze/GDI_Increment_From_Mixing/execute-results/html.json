{
  "hash": "ddd6254a8fdee829924fa0be367e2491",
  "result": {
    "markdown": "---\ntitle: \"GDI Increment From Mixing\"\nauthor: \"Marco Fantozzi\"\ndate: \"2024-01-24\"\noutput: html_document\n---\n\n\n\n\n## Preamble\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(assertthat)\nlibrary(rlang)\nlibrary(scales)\nlibrary(ggplot2)\nlibrary(zeallot)\nlibrary(data.table)\nlibrary(parallelDist)\nlibrary(tidyr)\nlibrary(tidyverse)\n#library(COTAN)\n\n#options(parallelly.fork.enable = TRUE)\n\ninDir <- file.path(\"Results\")\n\n#setLoggingLevel(2)\n#setLoggingFile(file.path(inDir, \"MixingClustersGDI_ForebrainDorsal.log\"))\n\noutDir <- file.path(inDir, \"GDI_Sensitivity\")\nif (!file.exists(outDir)) {\n  dir.create(outDir)\n}\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n## Load calculated data for analysis\n\n\n::: {.cell}\n\n:::\n\n\n## Recall cluster distance and add it to the results\n\n\n::: {.cell}\n\n```{.r .cell-code}\nzeroOneAvg <- readRDS(file.path(outDir, \"allZeroOne.RDS\"))\ndistZeroOne <- as.matrix(parDist(t(zeroOneAvg), method = \"hellinger\", diag = TRUE, upper = TRUE))^2\n\ndistZeroOneLong <- rownames_to_column(as.data.frame(distZeroOne), var = \"MainCluster\")\ndistZeroOneLong <-pivot_longer(distZeroOneLong,\n                               cols = !MainCluster,\n                               names_to = \"OtherCluster\", \n                               values_to = \"Distance\")\n\ndistZeroOneLong <- as.data.frame(distZeroOneLong[distZeroOneLong[[\"Distance\"]] != 0.0, ])\n\nassert_that(identical(distZeroOneLong[, 1:2], resMix20[, 1:2]))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n```{.r .cell-code}\nperm <- order(distZeroOneLong[[\"Distance\"]])\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Scatter plot of the effective increment at 40% mixing [Y]\n# against estimated distance [X]\ndistDF <- cbind(distZeroOneLong[, \"Distance\", drop = FALSE],\n                sqrt(distZeroOneLong[, \"Distance\", drop = FALSE]))\ncolnames(distDF) <- c(\"Distance\", \"DistanceSqrt\")\n\nD2IPlot <- ggplot(cbind(resMix40, distDF),\n                  aes(x=Distance, y=GDIIncrement)) +\n             geom_point() +\n             geom_smooth(method=lm, formula = y ~ x) \n           # +  xlim(0, 1.5) + ylim(0, 1.5) + coord_fixed()\n\nplot(D2IPlot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## Merge all data and plot it using the distance as discriminant\n\n\n::: {.cell}\n\n```{.r .cell-code}\nallRes <- rbind(resMix05[perm, ], resMix10[perm, ], resMix20[perm, ], resMix40[perm, ], resMix80[perm, ])\nallRes <- cbind(allRes, \"Distance\" = rep(distZeroOneLong[[\"Distance\"]][perm], 5))\nrownames(allRes) <- NULL\nallRes <- cbind(allRes, \"ClusterPair\" = rep.int(c(1:210),5))\n\n\nallResWithBase <- cbind(resMix00[perm, ], \"Distance\" = distZeroOneLong[[\"Distance\"]][perm])\nrownames(allResWithBase) <- NULL\nallResWithBase <- cbind(allResWithBase, \"ClusterPair\" = c(1:210))\nallResWithBase <- rbind(allResWithBase, allRes)\n\nassert_that(identical(allRes[, 4], allResWithBase[211:1260, 4]))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(allRes)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1050    7\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nIScPlot <- ggplot(allRes, aes(x=MixingFraction, y=GDIIncrement, color=Distance,)) +\n  geom_point() +\n  scale_color_continuous(type = \"viridis\") +\n  scale_x_log10()\n\nplot(IScPlot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nGScPlot <- ggplot(allResWithBase, aes(x=MixingFraction, y=GDI, color=Distance,)) +\n  geom_point() +\n  scale_color_continuous(type = \"viridis\")\n\nplot(GScPlot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreOrder <- function(df, numBlocks) {\n  blockLength <- nrow(df) / numBlocks\n  permut <- rep(1:blockLength, each = numBlocks) +\n              rep(seq(0, nrow(df) - 1, by = blockLength), times = numBlocks)\n  return(df[permut, ])\n}\n\nallRes2 <- reOrder(allRes, 5)\nallResWithBase2 <- reOrder(allResWithBase, 6)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrng <- c(1,210)\n#rng <- c(1,42)\n#rng <- c(43,84)\n#rng <- c(85,126)\n#rng <- c(127,168)\n#rng <- c(169,210)\n\nILinesPLot <- ggplot(allRes2[allRes2[[\"ClusterPair\"]] %between% rng, ],\n                     aes(x = MixingFraction, y = GDIIncrement,\n                         color = (ClusterPair - 1) %/% 35 + 0.5)) + \n  geom_path(aes(group = ClusterPair)) +\n  theme(legend.position = \"none\") +\n  #scale_x_log10() + \n  scale_colour_stepsn(colours = hcl.colors(6, palette = \"Dark 2\")[6:1])\n\nplot(ILinesPLot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\nGLinesPLot <- ggplot(allResWithBase2[allResWithBase2[[\"ClusterPair\"]] %between% rng, ],\n                     aes(x = MixingFraction, y = GDI,\n                         color = (ClusterPair - 1) %/% 35 + 0.5)) + \n  geom_path(aes(group = ClusterPair)) +\n  theme(legend.position = \"none\") +\n  #scale_x_log10() + \n  scale_colour_stepsn(colours = hcl.colors(6, palette = \"Dark 2\")[6:1]) \n#  geom_line(data = data.frame(cbind(MixingFraction = c(0,0.8), GDI = c(1.4,1.4))),\n#            aes(x = MixingFraction, y = GDI))\n\n\nplot(GLinesPLot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-9-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmg <- function(mixings) {\n  res <- mixings\n  res[res !=0 ] <- ceiling(log2(round(res[res !=0 ] * 40)))\n  return(res)\n}\n\nrng <- c(1,35)\n#rng <- c(43,84)\n#rng <- c(85,126)\n#rng <- c(127,168)\n#rng <- c(169,210)\n\nallRes$Group <- factor((allRes$ClusterPair - 1) %/% 35 + 1)\nlevels(allRes$Group) <- paste0(\"Distance bin \",c(1:6))\n\nallRes$discreteMixing <- factor(mg(allRes$MixingFraction))\nlevels(allRes$discreteMixing) <- c(\"0%\",\"5%\",\"10%\",\"20%\",\"40%\",\"80%\")\n\nIBoxPlot <- ggplot(allRes, aes(x=discreteMixing, \n                       y=GDIIncrement, \n                       fill=Group,\n                       group = discreteMixing)) +\n  geom_boxplot()+\n  geom_jitter(width=0.25, alpha=0.5) +\n  scale_colour_stepsn(colours = hcl.colors(6, palette = \"Dark 2\")[6:1]) +\n  facet_wrap(. ~ Group, ncol = 3)+\n  theme(legend.position = \"none\") \n\n\nplot(IBoxPlot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\nallResWithBase$Group <- factor((allResWithBase$ClusterPair - 1) %/% 35 + 1)\nlevels(allResWithBase$Group) <- paste0(\"Distance bin \",c(1:6))\n\n\nallResWithBase$discreteMixing <- factor(mg(allResWithBase$MixingFraction))\nlevels(allResWithBase$discreteMixing) <- c(\"0%\",\"5%\",\"10%\",\"20%\",\"40%\",\"80%\")\n\nGBoxPlot <- ggplot(allResWithBase,\n                   aes(x=discreteMixing, y=GDI, fill=Group,\n                              group = discreteMixing))+\n  geom_boxplot() +\n  geom_jitter(width=0.25, alpha=0.5) +\n  scale_colour_stepsn(colours = hcl.colors(6, palette = \"Dark 2\")[6:1]) +\n  facet_wrap(. ~ Group, ncol = 3)+\n  theme(legend.position = \"none\") \n\nplot(GBoxPlot)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n:::\n\n\n## Load calculated data about multi clusters cases for analysis\n\n\n::: {.cell}\n\n:::\n\n\n## Compare estimated vs real GDI increment\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Scatter plot of the effective increment [Y] against estimated increment [X]\npg <- ggplot(resMix20_2, aes(x=PredictedGDIIncrement, y=GDIIncrement)) +\n  geom_point() +\n  geom_smooth(method=lm, formula = y ~ x + 0) +\n  coord_fixed() +\n  xlim(0, 1.5) + ylim(0, 1.5)\n  #scale_x_log10() + scale_y_log10() \n\nplot(pg)\n```\n\n::: {.cell-output-display}\n![](GDI_Increment_From_Mixing_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nThe plot shows that having the 20% extraneous cells in the mixture coming from multiple clusters does not affect significantly the sensitivity of the GDI to score cluster uniformity.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 20.04.6 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0\n\nlocale:\n [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       \n [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   \n [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          \n[10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   \n\ntime zone: Europe/Rome\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] lubridate_1.9.2    forcats_1.0.0      stringr_1.5.0      dplyr_1.1.2       \n [5] purrr_1.0.1        readr_2.1.4        tibble_3.2.1       tidyverse_2.0.0   \n [9] tidyr_1.3.0        parallelDist_0.2.6 data.table_1.14.8  zeallot_0.1.0     \n[13] ggplot2_3.4.2      scales_1.3.0       rlang_1.1.1        assertthat_0.2.1  \n\nloaded via a namespace (and not attached):\n [1] utf8_1.2.3         generics_0.1.3     lattice_0.22-5     stringi_1.8.1     \n [5] hms_1.1.3          digest_0.6.33      magrittr_2.0.3     evaluate_0.21     \n [9] grid_4.3.2         timechange_0.2.0   fastmap_1.1.1      Matrix_1.6-3      \n[13] jsonlite_1.8.7     mgcv_1.9-1         fansi_1.0.4        viridisLite_0.4.2 \n[17] cli_3.6.1          munsell_0.5.0      splines_4.3.2      withr_2.5.0       \n[21] yaml_2.3.7         tools_4.3.2        tzdb_0.4.0         colorspace_2.1-0  \n[25] vctrs_0.6.3        R6_2.5.1           lifecycle_1.0.3    htmlwidgets_1.6.2 \n[29] pkgconfig_2.0.3    RcppParallel_5.1.7 pillar_1.9.0       gtable_0.3.3      \n[33] glue_1.6.2         Rcpp_1.0.11        xfun_0.39          tidyselect_1.2.0  \n[37] rstudioapi_0.15.0  knitr_1.43         farver_2.1.1       htmltools_0.5.7   \n[41] nlme_3.1-163       labeling_0.4.2     rmarkdown_2.24     compiler_4.3.2    \n```\n:::\n:::\n",
    "supporting": [
      "GDI_Increment_From_Mixing_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}