{
  "hash": "cc35a65dd2c7aad1edf08fad68f44f5f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"FDR analysis - Results - thresholds true 5% 20%\"\nauthor: \"Silvia Giulia Galfrè\"\ndate: \"2025-12-22\"\noutput: html_document\n---\n\n\n\n\n## Preamble\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(COTAN)\nlibrary(pROC)\noptions(parallelly.fork.enable = TRUE)\nlibrary(Seurat)\nlibrary(monocle3)\nlibrary(reticulate)\nlibrary(stringr)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(ggpubr)\n\ndirOut <- \"Results/FDR/\"\nif (!dir.exists(dirOut)) {\n  dir.create(dirOut)\n}\n\ndataSetDir <- \"Data/MouseCortexFromLoom/FDR/MergedClusters_For_FDR/\"\n```\n:::\n\n\n\n\n## Dataset composition\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatasets_csv <- read.csv(file.path(dataSetDir,\"Cells_Usage_DataFrame.csv\"),\n                         row.names = 1\n                        ) \n\ndatasets_csv[1:3,]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                 Group            Collection E13.5.432 E13.5.187 E13.5.434\n1 2_Clusters_even_near E13.5-434_+_E15.0-428         0         0       318\n2 2_Clusters_even_near E15.0-432_+_E13.5-432       536         0         0\n3 2_Clusters_even_near E15.0-508_+_E15.0-509         0         0         0\n  E13.5.184 E13.5.437 E13.5.510 E15.0.432 E15.0.509 E15.0.510 E15.0.508\n1         0         0         0         0         0         0         0\n2         0         0         0       536         0         0         0\n3         0         0         0         0       397         0       397\n  E15.0.428 E15.0.434 E15.0.437 E17.5.516 E17.5.505\n1       318         0         0         0         0\n2         0         0         0         0         0\n3         0         0         0         0         0\n```\n\n\n:::\n:::\n\n\n\n\n### Define which genes are expressed\n\nFor each data set we need to define, independently from the DEA methods, which genes are specific for each cluster. So we need to define first which genes are expressed and which are not expressed. To do so we can take advantage from the fact that we have the original clusters from which the cells were sampled to create the artificial datasets. So looking to the original cluster we define as expressed all genes present in at least the 20% of cells and we define as not expressed the genes completely absent or expressed in less than 5% of cells.\n\nSince these two thresholds can have a big influence on the tools performances we will test also others in other pages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfile.presence <- readRDS(\"Data/MouseCortexFromLoom/FDR/Results/GenePresence_PerCluster.RDS\")\n\nfor (file in list.files(\"Data/MouseCortexFromLoom/SingleClusterRawData/\")) {\n#  print(file)\n  Code <- str_split(file,pattern = \"_\",simplify = T)[1]\n  Time <- str_split(Code,pattern = \"e\",simplify = T)[2]\n  Cluster <- str_split(Code,pattern = \"e\",simplify = T)[1]\n  Cluster <- str_remove(Cluster,pattern = \"Cl\")\n  Cluster <- paste0(\"E\",Time,\"-\",Cluster)\n  file.presence[,Cluster] <- \"Absent\"\n  dataset.cl <- readRDS(file.path(\"Data/MouseCortexFromLoom/SingleClusterRawData/\",\n                                         file))\n  number.cell.expressing <- rowSums(dataset.cl > 0)\n  AbsentThreshold <- round(0.05*dim(dataset.cl)[2],digits = 0)\n  PresenceThreshold <- round(0.2*dim(dataset.cl)[2],digits = 0)\n  file.presence[names(number.cell.expressing[number.cell.expressing > AbsentThreshold]),Cluster] <- \"Uncertain\" \n  \n  file.presence[names(number.cell.expressing[number.cell.expressing >= PresenceThreshold]),Cluster] <- \"Present\"\n  print(Cluster)\n  print(table(file.presence[,Cluster]))\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-184\"\n\n   Absent   Present Uncertain \n     6719      3476      4500 \n[1] \"E13.5-187\"\n\n   Absent   Present Uncertain \n     5930      4609      4156 \n[1] \"E15.0-428\"\n\n   Absent   Present Uncertain \n     7470      2864      4361 \n[1] \"E13.5-432\"\n\n   Absent   Present Uncertain \n     6847      3640      4208 \n[1] \"E15.0-432\"\n\n   Absent   Present Uncertain \n     6951      3514      4230 \n[1] \"E13.5-434\"\n\n   Absent   Present Uncertain \n     7191      3185      4319 \n[1] \"E15.0-434\"\n\n   Absent   Present Uncertain \n     7554      3028      4113 \n[1] \"E13.5-437\"\n\n   Absent   Present Uncertain \n     7024      3430      4241 \n[1] \"E15.0-437\"\n\n   Absent   Present Uncertain \n     7090      3419      4186 \n[1] \"E17.5-505\"\n\n   Absent   Present Uncertain \n     7141      3154      4400 \n[1] \"E15.0-508\"\n\n   Absent   Present Uncertain \n     6637      3892      4166 \n[1] \"E15.0-509\"\n\n   Absent   Present Uncertain \n     6495      4039      4161 \n[1] \"E13.5-510\"\n\n   Absent   Present Uncertain \n     5961      4541      4193 \n[1] \"E15.0-510\"\n\n   Absent   Present Uncertain \n     6082      4480      4133 \n[1] \"E17.5-516\"\n\n   Absent   Present Uncertain \n     6931      3496      4268 \n```\n\n\n:::\n:::\n\n\n\n\n# 2 Clusters even\n\n## 2_Clusters_even_near\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_even_near\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set             set_number\n  <chr> <chr>     <lgl> <chr>                     <int>\n1 Neil2 E13.5-434 FALSE 2_Clusters_even_near          1\n2 Neil2 E15.0-428 FALSE 2_Clusters_even_near          1\n3 Lamc1 E13.5-434 FALSE 2_Clusters_even_near          1\n4 Lamc1 E15.0-428 FALSE 2_Clusters_even_near          1\n5 Lama1 E13.5-434 FALSE 2_Clusters_even_near          1\n6 Lama1 E15.0-428 FALSE 2_Clusters_even_near          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-434\"\n[1] \"E15.0-428\"\n[1] \"E15.0-432\"\n[1] \"E13.5-432\"\n[1] \"E15.0-509\"\n[1] \"E15.0-508\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwoClusters_even_near <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,\n                 Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwoClusters_even_nearPL <- TwoClusters_even_near + xlab(\"FPR\") + ylab(\"TPR\")\nTwoClusters_even_nearPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n## 2_Clusters_even_medium\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_even_medium\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set               set_number\n  <chr> <chr>     <lgl> <chr>                       <int>\n1 Neil2 E13.5-187 FALSE 2_Clusters_even_medium          1\n2 Neil2 E13.5-184 FALSE 2_Clusters_even_medium          1\n3 Lamc1 E13.5-187 FALSE 2_Clusters_even_medium          1\n4 Lamc1 E13.5-184 FALSE 2_Clusters_even_medium          1\n5 Lama1 E13.5-187 FALSE 2_Clusters_even_medium          1\n6 Lama1 E13.5-184 FALSE 2_Clusters_even_medium          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 447\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-187\"\n[1] \"E13.5-184\"\n[1] \"E17.5-516\"\n[1] \"E15.0-434\"\n[1] \"E15.0-508\"\n[1] \"E15.0-437\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwo_Clusters_even_medium <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwo_Clusters_even_mediumPL <- Two_Clusters_even_medium + xlab(\"FPR\") + ylab(\"TPR\")\nTwo_Clusters_even_mediumPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n## 2_Clusters_even_far\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_even_far\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set            set_number\n  <chr> <chr>     <lgl> <chr>                    <int>\n1 Neil2 E17.5-516 FALSE 2_Clusters_even_far          1\n2 Neil2 E13.5-187 FALSE 2_Clusters_even_far          1\n3 Lamc1 E17.5-516 FALSE 2_Clusters_even_far          1\n4 Lamc1 E13.5-187 FALSE 2_Clusters_even_far          1\n5 Lama1 E17.5-516 FALSE 2_Clusters_even_far          1\n6 Lama1 E13.5-187 FALSE 2_Clusters_even_far          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1359\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-187\"\n[1] \"E17.5-516\"\n[1] \"E15.0-510\"\n[1] \"E13.5-437\"\n[1] \"E15.0-509\"\n[1] \"E13.5-184\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwo_Clusters_even_far <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwo_Clusters_even_farPL <- Two_Clusters_even_far + xlab(\"FPR\") + ylab(\"TPR\")\nTwo_Clusters_even_farPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n# 2 clusters uneven\n\n## 2_Clusters_uneven_near\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_uneven_near\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set               set_number\n  <chr> <chr>     <lgl> <chr>                       <int>\n1 Neil2 E13.5-434 FALSE 2_Clusters_uneven_near          1\n2 Neil2 E15.0-428 FALSE 2_Clusters_uneven_near          1\n3 Lamc1 E13.5-434 FALSE 2_Clusters_uneven_near          1\n4 Lamc1 E15.0-428 FALSE 2_Clusters_uneven_near          1\n5 Lama1 E13.5-434 FALSE 2_Clusters_uneven_near          1\n6 Lama1 E15.0-428 FALSE 2_Clusters_uneven_near          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-434\"\n[1] \"E15.0-428\"\n[1] \"E15.0-432\"\n[1] \"E13.5-432\"\n[1] \"E15.0-509\"\n[1] \"E15.0-508\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\nplot(roc_resultSeurat)\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/seurat4-1.png){width=672}\n:::\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwo_Clusters_uneven_near <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwo_Clusters_uneven_nearPL <- Two_Clusters_uneven_near + xlab(\"FPR\") + ylab(\"TPR\")\nTwo_Clusters_uneven_nearPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n\n\n## 2_Clusters_uneven_medium\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_uneven_medium\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set                 set_number\n  <chr> <chr>     <lgl> <chr>                         <int>\n1 Neil2 E13.5-187 FALSE 2_Clusters_uneven_medium          1\n2 Neil2 E13.5-184 FALSE 2_Clusters_uneven_medium          1\n3 Lamc1 E13.5-187 FALSE 2_Clusters_uneven_medium          1\n4 Lamc1 E13.5-184 FALSE 2_Clusters_uneven_medium          1\n5 Lama1 E13.5-187 FALSE 2_Clusters_uneven_medium          1\n6 Lama1 E13.5-184 FALSE 2_Clusters_uneven_medium          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 447\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-187\"\n[1] \"E13.5-184\"\n[1] \"E17.5-516\"\n[1] \"E15.0-434\"\n[1] \"E15.0-508\"\n[1] \"E15.0-437\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwo_Clusters_uneven_medium <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwo_Clusters_uneven_mediumPL <- Two_Clusters_uneven_medium + xlab(\"FPR\") + ylab(\"TPR\")\n\nTwo_Clusters_uneven_mediumPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n\n\n## 2_Clusters_uneven_far\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"2_Clusters_uneven_far\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set              set_number\n  <chr> <chr>     <lgl> <chr>                      <int>\n1 Neil2 E17.5-516 FALSE 2_Clusters_uneven_far          1\n2 Neil2 E13.5-187 FALSE 2_Clusters_uneven_far          1\n3 Lamc1 E17.5-516 FALSE 2_Clusters_uneven_far          1\n4 Lamc1 E13.5-187 FALSE 2_Clusters_uneven_far          1\n5 Lama1 E17.5-516 FALSE 2_Clusters_uneven_far          1\n6 Lama1 E13.5-187 FALSE 2_Clusters_uneven_far          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1359\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-187\"\n[1] \"E17.5-516\"\n[1] \"E15.0-510\"\n[1] \"E13.5-437\"\n[1] \"E15.0-509\"\n[1] \"E13.5-184\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTwo_Clusters_uneven_far <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nTwo_Clusters_uneven_farPL <- Two_Clusters_uneven_far + xlab(\"FPR\") + ylab(\"TPR\")\n\nTwo_Clusters_uneven_farPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n\n\n# 3 clusters\n\n## 3_Clusters_even\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"3_Clusters_even\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set        set_number\n  <chr> <chr>     <lgl> <chr>                <int>\n1 Neil2 E15.0-437 FALSE 3_Clusters_even          1\n2 Neil2 E13.5-510 FALSE 3_Clusters_even          1\n3 Neil2 E13.5-437 FALSE 3_Clusters_even          1\n4 Lamc1 E15.0-437 FALSE 3_Clusters_even          1\n5 Lamc1 E13.5-510 FALSE 3_Clusters_even          1\n6 Lamc1 E13.5-437 FALSE 3_Clusters_even          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1305\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-437\"\n[1] \"E15.0-437\"\n[1] \"E13.5-510\"\n[1] \"E17.5-516\"\n[1] \"E13.5-437\"\n[1] \"E17.5-505\"\n[1] \"E15.0-510\"\n[1] \"E15.0-428\"\n[1] \"E13.5-510\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nThree_Clusters_even <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nThree_Clusters_evenPL <- Three_Clusters_even + \n  xlab(\"FPR\") + ylab(\"TPR\")+theme(legend.position=\"none\")\nThree_Clusters_even\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n\n\n\n## 3_Clusters_uneven\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"3_Clusters_uneven\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set          set_number\n  <chr> <chr>     <lgl> <chr>                  <int>\n1 Neil2 E15.0-428 FALSE 3_Clusters_uneven          1\n2 Neil2 E13.5-434 FALSE 3_Clusters_uneven          1\n3 Neil2 E15.0-510 FALSE 3_Clusters_uneven          1\n4 Lamc1 E15.0-428 FALSE 3_Clusters_uneven          1\n5 Lamc1 E13.5-434 FALSE 3_Clusters_uneven          1\n6 Lamc1 E15.0-510 FALSE 3_Clusters_uneven          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1577\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E15.0-510\"\n[1] \"E13.5-434\"\n[1] \"E15.0-428\"\n[1] \"E15.0-432\"\n[1] \"E13.5-432\"\n[1] \"E13.5-187\"\n[1] \"E15.0-509\"\n[1] \"E15.0-508\"\n[1] \"E13.5-184\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n#onlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[order(onlyPositive.pVal.Cotan_tot$p_values,\n #                                                                decreasing = F),]\n# df <- as.data.frame(matrix(nrow = nrow(onlyPositive.pVal.Cotan_tot),ncol = 3)) \n# colnames(df) <- c(\"TPR\",\"FPR\",\"Method\")\n# df$Method <- \"COTAN\"\n# \n# Positive <- sum(onlyPositive.pVal.Cotan_tot$value) \n# Negative <- sum(!onlyPositive.pVal.Cotan_tot$value)\n# \n# for (i in 1:nrow(onlyPositive.pVal.Cotan_tot)) {\n#   df[i,\"TPR\"] <- sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"])/Positive\n#   df[i,\"FPR\"] <- (i-sum(onlyPositive.pVal.Cotan_tot[1:i,\"value\"]))/Negative\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nThree_Clusters_uneven <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\nThree_Clusters_unevenPL <- Three_Clusters_uneven + xlab(\"FPR\") + ylab(\"TPR\")+theme(legend.position=\"none\")\n\nThree_Clusters_uneven\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n:::\n\n\n\n\n# 5 clusters\n\n## 5_Clusters_uneven\n\n### True vector\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset.datasets_csv <-datasets_csv[datasets_csv$Group == \"5_Clusters_uneven\",] \n\nground_truth_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  clusters <- str_split(subset.datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  file.presence.subset <- file.presence[,clusters]\n  \n  \n  #file.presence.subset <- as.matrix(file.presence.subset)\n  \n  \n  ground_truth <- as.data.frame(matrix(nrow = nrow(file.presence.subset),\n                                       ncol = ncol(file.presence.subset)))\n  rownames(ground_truth) <- rownames(file.presence.subset)\n  colnames(ground_truth) <- colnames(file.presence.subset)\n  \n  ground_truth[file.presence.subset == \"Absent\"] <- 0\n  ground_truth[file.presence.subset == \"Present\"] <- 1\n  ground_truth[file.presence.subset == \"Uncertain\"] <- 0.6\n  \n  file.presence.subset <- ground_truth\n  \n  for (col in 1:ncol(ground_truth)) {\n    ground_truth[,col] <- FALSE  \n    ground_truth[file.presence.subset[,col] == 1 & rowMeans(file.presence.subset[,-col,drop = FALSE]) < 0.555  ,col] <- TRUE\n    }\n  \n  ground_truth$genes <- rownames(ground_truth) \n  ground_truth <- pivot_longer(ground_truth,\n                               cols = 1:(ncol(ground_truth)-1),\n                               names_to = \"clusters\")\n  ground_truth$data_set <- subset.datasets_csv[ind,1]\n  ground_truth$set_number <- ind \n  ground_truth_tot <- rbind(ground_truth_tot, ground_truth)\n  \n}\nground_truth_tot <- ground_truth_tot[2:nrow(ground_truth_tot),]\n\nhead(ground_truth_tot)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  genes clusters  value data_set          set_number\n  <chr> <chr>     <lgl> <chr>                  <int>\n1 Neil2 E13.5-510 FALSE 5_Clusters_uneven          1\n2 Neil2 E15.0-437 FALSE 5_Clusters_uneven          1\n3 Neil2 E15.0-510 FALSE 5_Clusters_uneven          1\n4 Neil2 E13.5-432 FALSE 5_Clusters_uneven          1\n5 Neil2 E13.5-437 FALSE 5_Clusters_uneven          1\n6 Lamc1 E13.5-510 FALSE 5_Clusters_uneven          1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(ground_truth_tot$genes)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14695\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(ground_truth_tot$value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1862\n```\n\n\n:::\n:::\n\n\n\n\n### ROC for COTAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",\n                      subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  deaCOTAN <- getClusterizationData(dataset,clName = \"mergedClusters\")[[2]]\n  pvalCOTAN <- pValueFromDEA(deaCOTAN,\n              numCells = getNumCells(dataset),adjustmentMethod = \"none\")\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.names <- c(cl.names,\n                  str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1])\n    cl.names <- cl.names[!is.na(cl.names)]\n  }\n  colnames(deaCOTAN) <- cl.names\n  colnames(pvalCOTAN) <- cl.names\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  onlyPositive.pVal.Cotan <- pvalCOTAN\n\n    for (cl in cl.names) {\n    print(cl)\n    #temp.DEA.CotanSign <- deaCOTAN[rownames(pvalCOTAN[pvalCOTAN[,cl] < 0.05,]) ,]\n    onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl] <-  1 #onlyPositive.pVal.Cotan[rownames(deaCOTAN[deaCOTAN[,cl] < 0,]),cl]+1\n    }\n    \n    onlyPositive.pVal.Cotan$genes <- rownames(onlyPositive.pVal.Cotan) \n    onlyPositive.pVal.Cotan <- pivot_longer(onlyPositive.pVal.Cotan,\n                                            values_to = \"p_values\",\n                               cols = 1:(ncol(onlyPositive.pVal.Cotan)-1),\n                               names_to = \"clusters\")\n  onlyPositive.pVal.Cotan$data_set <- subset.datasets_csv[ind,1]\n  onlyPositive.pVal.Cotan$set_number <- ind \n  onlyPositive.pVal.Cotan_tot <- rbind(onlyPositive.pVal.Cotan_tot, onlyPositive.pVal.Cotan)\n  \n  }\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"E13.5-432\"\n[1] \"E15.0-510\"\n[1] \"E13.5-437\"\n[1] \"E15.0-437\"\n[1] \"E13.5-510\"\n[1] \"E13.5-434\"\n[1] \"E15.0-428\"\n[1] \"E13.5-184\"\n[1] \"E15.0-434\"\n[1] \"E17.5-505\"\n[1] \"E15.0-432\"\n[1] \"E13.5-432\"\n[1] \"E15.0-509\"\n[1] \"E15.0-508\"\n[1] \"E13.5-187\"\n```\n\n\n:::\n\n```{.r .cell-code}\nonlyPositive.pVal.Cotan_tot <- onlyPositive.pVal.Cotan_tot[2:nrow(onlyPositive.pVal.Cotan_tot),]\n\nonlyPositive.pVal.Cotan_tot <- merge.data.frame(onlyPositive.pVal.Cotan_tot,\n                                                ground_truth_tot,by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),all.x = T,all.y = F)\n\n\n  \n# Convert TRUE/FALSE to 1/0\nonlyPositive.pVal.Cotan_tot$value <- as.numeric(onlyPositive.pVal.Cotan_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultCOTAN <- roc(onlyPositive.pVal.Cotan_tot$value, 1 - onlyPositive.pVal.Cotan_tot$p_values)\n\n# Plot the ROC curve\n#plot(roc_resultCOTAN)\n```\n:::\n\n\n\n\n### ROC for Seurat\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n\n# Plot the ROC curve\n#plot(roc_resultSeurat)\n```\n:::\n\n\n\n\n### ROC for Seurat scTransform\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_ScTransform_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_scTr <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Seurat Bimod\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaSeurat_tot <- NA\n\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  #print(ind)\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  \n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  \n  deaSeurat <- read.csv(file.path(dirOut,paste0(file.code,\"Seurat_DEA_Bimod_genes.csv\")), row.names = 1)\n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaSeurat[deaSeurat$cluster == cl.val,]$cluster <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"cluster\",\n                                     replacement = \"clusters\") \n  colnames(deaSeurat) <- str_replace(colnames(deaSeurat),\n                                     pattern = \"gene\",\n                                     replacement = \"genes\") \n  \n  deaSeurat$data_set <- subset.datasets_csv[ind,1]\n  deaSeurat$set_number <- ind \n  deaSeurat_tot <- rbind(deaSeurat_tot, deaSeurat)\n  \n  \n  }\n deaSeurat_tot <-  deaSeurat_tot[2:nrow(deaSeurat_tot),]\n \n deaSeurat_tot <- merge.data.frame(deaSeurat_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaSeurat_tot$value <- as.numeric(deaSeurat_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultSeurat_Bimod <- roc(deaSeurat_tot$value, 1 - deaSeurat_tot$p_val)\n```\n:::\n\n\n\n\n### ROC for Monocle\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaMonocle_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n  \n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaMonocle <- read.csv(file.path(dirOut,paste0(file.code,\"Monocle_DEA_genes.csv\")),row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaMonocle[deaMonocle$cell_group == cl.val,\"cell_group\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n  \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"cell_group\",\n                                     replacement = \"clusters\") \n  colnames(deaMonocle) <- str_replace(colnames(deaMonocle),\n                                     pattern = \"gene_id\",\n                                     replacement = \"genes\")\n  \n  deaMonocle$data_set <- subset.datasets_csv[ind,1]\n  deaMonocle$set_number <- ind \n  deaMonocle <- as.data.frame(deaMonocle)\n  deaMonocle_tot <- rbind(deaMonocle_tot, deaMonocle)\n  \n  \n  }\n deaMonocle_tot <-  deaMonocle_tot[2:nrow(deaMonocle_tot),]\n \n deaMonocle_tot <- merge.data.frame(deaMonocle_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaMonocle_tot$value <- as.numeric(deaMonocle_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultMonocle <- roc(deaMonocle_tot$value, 1 - deaMonocle_tot$marker_test_p_value)\n\n# Plot the ROC curve\n#plot(roc_resultMonocle)\n```\n:::\n\n\n\n\n### ROC from ScamPy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaScamPy_tot <- NA\nfor (ind in 1:dim(subset.datasets_csv)[1]) {\n  file.code <- paste0(subset.datasets_csv$Group[ind],\"_\",subset.datasets_csv$Collection[ind])\n  dataset <- readRDS(file = file.path(dataSetDir,paste0(file.code,\".RDS\")))\n\n  clusterization <- getClusterizationData(dataset, clName = \"mergedClusters\")[[1]]\n  #print(file.code)\n  \n  deaScamPy <- read.csv(file.path(dirOut,paste0(file.code,\"ScanPy_DEA_genes.csv\")),\n                        row.names = 1) \n  \n  cl.names <- NA\n  \n  for (cl.val in  unique(clusterization)) {\n    #print(cl.val)\n    cl.name <- str_split(names(clusterization[clusterization == cl.val])[1],\n                            pattern = \"_\",simplify = T)[1]\n    cl.names <- c(cl.names,cl.name)\n    cl.names <- cl.names[!is.na(cl.names)]\n  \n    deaScamPy[deaScamPy$clusters == paste0(\"cl\",cl.val),\"clusters\"] <- cl.name   \n  \n  }\n  \n  clusters <- str_split(datasets_csv$Collection[ind],pattern = \"_[+]_\",simplify = T)\n\n\n  deaScamPy$data_set <- subset.datasets_csv[ind,1]\n  deaScamPy$set_number <- ind \n  deaScamPy_tot <- rbind(deaScamPy_tot, deaScamPy)\n  \n  \n  }\n deaScamPy_tot <-  deaScamPy_tot[2:nrow(deaScamPy_tot),]\n \n deaScamPy_tot <- merge.data.frame(deaScamPy_tot,\n                                   ground_truth_tot,\n                                   by = c(\"genes\",\"clusters\",\"data_set\",\"set_number\"),\n                                   all.x = T,all.y = F)\n\n# Convert TRUE/FALSE to 1/0\ndeaScamPy_tot$value <- as.numeric(deaScamPy_tot$value)\n\n# Compute the ROC curve - note that we invert the p-values with 1 - p_values\nroc_resultScamPy <- roc(deaScamPy_tot$value, 1 - deaScamPy_tot$pval)\n\n# Plot the ROC curve\n#plot(roc_resultScamPy)\n```\n:::\n\n\n\n\n### Summary ROC for all methods\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nFive_Clusters <- ggroc(list(COTAN=roc_resultCOTAN, Seurat=roc_resultSeurat,                  Seurat_scTr = roc_resultSeurat_scTr, Seurat_Bimod = roc_resultSeurat_Bimod,\n                 Monocle=roc_resultMonocle, ScamPy=roc_resultScamPy))\n\n \nFive_Clusters_unevenPL <- Five_Clusters + xlab(\"FPR\") + ylab(\"TPR\")\n\nFive_Clusters_unevenPL\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-48-1.png){width=672}\n:::\n:::\n\n\n\n\n# Global Summary\n\n## 2 Clusters\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggarrange(TwoClusters_even_nearPL,Two_Clusters_even_mediumPL, Two_Clusters_even_farPL,Two_Clusters_uneven_nearPL, Two_Clusters_uneven_mediumPL,Two_Clusters_uneven_farPL,\n          labels = c(\"Even_Near\", \"Even_Medium\", \"Even_Far\", \"Uneven_Near\",\"Uneven_Medium\",\"Uneven_Far\"),\n          ncol = 3, nrow = 2, common.legend = T, legend = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-49-1.png){width=1440}\n:::\n:::\n\n\n\n\n## 3 and 5 Clusters\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggarrange(Three_Clusters_evenPL,Three_Clusters_unevenPL, NULL, Five_Clusters_unevenPL,\n          labels = c(\"3_Even\", \"3_Uneven\", \"\", \"5_Uneven\"),\n          ncol = 2, nrow = 2, common.legend = T, legend = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](FDR_analisysResults5_20_files/figure-html/unnamed-chunk-50-1.png){width=960}\n:::\n:::\n\n\n\n\n## Footer\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.2 (2025-10-31)\nPlatform: x86_64-pc-linux-gnu\nRunning under: Ubuntu 22.04.5 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0  LAPACK version 3.10.0\n\nlocale:\n [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       \n [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   \n [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          \n[10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   \n\ntime zone: Europe/Rome\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] ggpubr_0.6.0                ggplot2_4.0.1              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] stringr_1.5.1               reticulate_1.42.0          \n [7] monocle3_1.3.7              SingleCellExperiment_1.30.0\n [9] SummarizedExperiment_1.38.1 GenomicRanges_1.60.0       \n[11] GenomeInfoDb_1.44.0         IRanges_2.42.0             \n[13] S4Vectors_0.46.0            MatrixGenerics_1.20.0      \n[15] matrixStats_1.5.0           Biobase_2.68.0             \n[17] BiocGenerics_0.54.0         generics_0.1.3             \n[19] Seurat_5.2.1                SeuratObject_5.1.0         \n[21] sp_2.2-0                    pROC_1.18.5                \n[23] COTAN_2.9.4                \n\nloaded via a namespace (and not attached):\n  [1] RcppAnnoy_0.0.22        splines_4.5.2           later_1.4.2            \n  [4] tibble_3.3.0            polyclip_1.10-7         fastDummies_1.7.5      \n  [7] lifecycle_1.0.4         rstatix_0.7.2           Rdpack_2.6.4           \n [10] doParallel_1.0.17       globals_0.18.0          lattice_0.22-7         \n [13] MASS_7.3-65             backports_1.5.0         dendextend_1.19.0      \n [16] magrittr_2.0.4          plotly_4.11.0           rmarkdown_2.29         \n [19] yaml_2.3.10             httpuv_1.6.16           sctransform_0.4.2      \n [22] spam_2.11-1             spatstat.sparse_3.1-0   minqa_1.2.8            \n [25] cowplot_1.1.3           pbapply_1.7-2           RColorBrewer_1.1-3     \n [28] abind_1.4-8             Rtsne_0.17              purrr_1.2.0            \n [31] circlize_0.4.16         GenomeInfoDbData_1.2.14 ggrepel_0.9.6          \n [34] irlba_2.3.5.1           listenv_0.9.1           spatstat.utils_3.1-4   \n [37] goftest_1.2-3           RSpectra_0.16-2         spatstat.random_3.4-1  \n [40] fitdistrplus_1.2-2      parallelly_1.45.0       codetools_0.2-20       \n [43] DelayedArray_0.34.1     tidyselect_1.2.1        shape_1.4.6.1          \n [46] UCSC.utils_1.4.0        farver_2.1.2            lme4_1.1-37            \n [49] ScaledMatrix_1.16.0     viridis_0.6.5           spatstat.explore_3.4-2 \n [52] jsonlite_2.0.0          GetoptLong_1.0.5        gghalves_0.1.4         \n [55] Formula_1.2-5           progressr_0.15.1        ggridges_0.5.6         \n [58] survival_3.8-3          iterators_1.0.14        foreach_1.5.2          \n [61] tools_4.5.2             ica_1.0-3               Rcpp_1.0.14            \n [64] glue_1.8.0              gridExtra_2.3           SparseArray_1.8.0      \n [67] xfun_0.52               ggthemes_5.1.0          withr_3.0.2            \n [70] fastmap_1.2.0           boot_1.3-32             digest_0.6.37          \n [73] rsvd_1.0.5              parallelDist_0.2.6      R6_2.6.1               \n [76] mime_0.13               colorspace_2.1-1        scattermore_1.2        \n [79] tensor_1.5              spatstat.data_3.1-6     utf8_1.2.5             \n [82] data.table_1.17.0       httr_1.4.7              htmlwidgets_1.6.4      \n [85] S4Arrays_1.8.0          uwot_0.2.3              pkgconfig_2.0.3        \n [88] gtable_0.3.6            ComplexHeatmap_2.24.0   lmtest_0.9-40          \n [91] S7_0.2.1                XVector_0.48.0          htmltools_0.5.8.1      \n [94] carData_3.0-5           dotCall64_1.2           zigg_0.0.2             \n [97] clue_0.3-66             scales_1.4.0            png_0.1-8              \n[100] reformulas_0.4.1        spatstat.univar_3.1-3   knitr_1.50             \n[103] reshape2_1.4.4          rjson_0.2.23            nloptr_2.2.1           \n[106] nlme_3.1-168            proxy_0.4-27            zoo_1.8-14             \n[109] GlobalOptions_0.1.2     KernSmooth_2.23-26      parallel_4.5.2         \n[112] miniUI_0.1.2            pillar_1.10.2           grid_4.5.2             \n[115] vctrs_0.6.5             RANN_2.6.2              promises_1.3.2         \n[118] car_3.1-3               BiocSingular_1.24.0     beachmat_2.24.0        \n[121] xtable_1.8-4            cluster_2.1.8.1         evaluate_1.0.3         \n[124] zeallot_0.2.0           cli_3.6.5               compiler_4.5.2         \n[127] rlang_1.1.6             crayon_1.5.3            ggsignif_0.6.4         \n[130] future.apply_1.20.0     labeling_0.4.3          plyr_1.8.9             \n[133] stringi_1.8.7           viridisLite_0.4.2       deldir_2.0-4           \n[136] BiocParallel_1.42.0     assertthat_0.2.1        lazyeval_0.2.2         \n[139] spatstat.geom_3.4-1     Matrix_1.7-4            RcppHNSW_0.6.0         \n[142] patchwork_1.3.2         future_1.58.0           shiny_1.11.0           \n[145] rbibutils_2.3           ROCR_1.0-11             Rfast_2.1.5.1          \n[148] broom_1.0.8             igraph_2.1.4            RcppParallel_5.1.10    \n```\n\n\n:::\n:::",
    "supporting": [
      "FDR_analisysResults5_20_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}